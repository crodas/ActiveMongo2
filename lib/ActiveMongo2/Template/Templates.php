<?php
/**
 *  This file was generated with crodas/SimpleView (https://github.com/crodas/SimpleView)
 *  Do not edit this file.
 *
 */

namespace {


    class base_template_df562f12800ad133cdbc6f040ca106a099504656
    {
        protected $parent;
        protected $child;
        protected $context;

        public function yield_parent($name, $args)
        {
            $method = "section_" . sha1($name);

            if (is_callable(array($this->parent, $method))) {
                $this->parent->$method(array_merge($this->context, $args));
                return true;
            }

            if ($this->parent) {
                return $this->parent->yield_parent($name, $args);
            }

            return false;
        }

        public function do_yield($name, Array $args = array())
        {
            if ($this->child) {
                // We have a children template, we are their base
                // so let's see if they have implemented by any change
                // this section
                if ($this->child->do_yield($name, $args)) {
                    // yes!
                    return true;
                }
            }

            // Do I have this section defined?
            $method = "section_" . sha1($name);
            if (is_callable(array($this, $method))) {
                // Yes!
                $this->$method(array_merge($this->context, $args));
                return true;
            }

            // No :-(
            return false;
        }

    }

    /** 
     *  Template class generated from Callback.tpl
     */
    class class_1895ec604b22a2e3f627b9d8d7ae6142d332247e extends base_template_df562f12800ad133cdbc6f040ca106a099504656
    {

        public function hasSection($name)
        {

            return false;
        }


        public function renderSection($name, Array $args = array(), $fail_on_missing = true)
        {
            if (!$this->hasSection($name)) {
                if ($fail_on_missing) {
                    throw new \RuntimeException("Cannot find section {$name}");
                }
                return "";
            }

        }

        public function enhanceException(Exception $e, $section = NULL)
        {
            if (!empty($e->enhanced)) {
                return;
            }

            $message = $e->getMessage() . "( IN " . 'Callback.tpl';
            if ($section) {
                $message .= " | section: {$section}";
            }
            $message .= ")";

            $object   = new ReflectionObject($e);
            $property = $object->getProperty('message');
            $property->setAccessible(true);
            $property->setValue($e, $message);

            $e->enhanced = true;
        }

        public function render(Array $vars = array(), $return = false)
        {
            try {
                return $this->_render($vars, $return);
            } catch (Exception $e) {
                if ($return) ob_get_clean();
                $this->enhanceException($e);
                throw $e;
            }
        }

        public function _render(Array $vars = array(), $return = false)
        {
            $this->context = $vars;

            extract($vars);
            if ($return) {
                ob_start();
            }

            if (!$self->isEmbeddable()) {
                echo "    if (empty(self::\$loaded[";
                var_export($self->getPath());
                echo "])) {\n";
                if ($self->isClass()) {
                    echo "            if (!" . ($self->getAnnotation()->getObject()->getType()) . "_exists(";
                    var_export($self->getClass());
                    echo ", false)) {\n";
                }
                else if ($self->isMethod()) {
                    echo "            if (!" . ($self->getAnnotation()->getObject()->getClass()->getObject()->getType()) . "_exists(";
                    var_export($self->getClass());
                    echo ", false)) {\n";
                }
                else {
                    echo "            if (!function_exists(";
                    var_export($self->getFunction());
                    echo ")) {\n";
                }

                echo "            require ";
                var_export($self->getPath());
                echo ";\n        }\n        self::\$loaded[";
                var_export($self->getPath());
                echo "] = true;\n    }\n";
            }
            echo "\n\$args = empty(\$args) ? [] : \$args;\n\n";
            if ($self->isEmbeddable()) {
                echo "    " . ($self->toEmbedCode($var)) . "\n";
            }
            else if ($self->isMethod()) {
                if ($self->isPublic()) {
                    if ($self->isStatic()) {
                        echo "            \$return = \\" . ($self->getClass()) . "::" . ($self->getMethod()) . "(\n";
                    }
                    else if ($prop->getClass() == $self->getClass()) {
                        echo "            \$return = \$document->" . ($self->getMethod()) . "(\n";
                    }
                    else {
                        echo "            // Improve me (should construct once and reuse it)\n            // ";
                        echo get_class($self) . " _ " . get_class($self->getAnnotation()) . "\n            \$return = (new \\";
                        echo $self->getClass() . ")->" . ($self->getMethod()) . "(\n";
                    }

                    echo "            " . ($var) . ", // document variable \n            \$args,  // external arguments (defined at run time)\n            \$this->connection, // connection\n            ";
                    var_export($args);
                    echo ", // annotation arguments\n            \$this, // mapper instance\n            ";
                    var_export($prop->getClass());
                    echo "\n        );\n";
                }
                else {
                    echo "        \$reflection = new \\ReflectionMethod(";
                    var_export("\\". $self->getClass());
                    echo ", ";
                    var_export($self->getMethod());
                    echo ");\n        \$reflection->setAccessible(true);\n        \$return = \$reflection->invoke(\n            ";
                    echo $var . ", // document variable \n            \$args,  // external arguments (defined at run time)\n            \$this->connection, // connection\n            ";
                    var_export($args);
                    echo ", // annotation arguments\n            \$this, // mapper instance\n            ";
                    var_export($prop->getClass());
                    echo "\n        );\n";
                }
            }
            else {
                echo "    \$return = \\" . ($self->getFunction()) . "(\n        ";
                echo $var . ", // document variable \n        \$args,  // external arguments (defined at run time)\n        \$this->connection, // connection\n        ";
                var_export($args);
                echo ", // annotation arguments\n        \$this, // mapper instance\n        ";
                var_export($prop->getClass());
                echo "\n    );\n";
            }


            if ($return) {
                return ob_get_clean();
            }

        }
    }

    /** 
     *  Template class generated from Documents.tpl.php
     */
    class class_4c3d011cafbc519bc12f3ed430a4e169ad8b5e8b extends base_template_df562f12800ad133cdbc6f040ca106a099504656
    {

        public function hasSection($name)
        {

            return false;
        }


        public function renderSection($name, Array $args = array(), $fail_on_missing = true)
        {
            if (!$this->hasSection($name)) {
                if ($fail_on_missing) {
                    throw new \RuntimeException("Cannot find section {$name}");
                }
                return "";
            }

        }

        public function enhanceException(Exception $e, $section = NULL)
        {
            if (!empty($e->enhanced)) {
                return;
            }

            $message = $e->getMessage() . "( IN " . 'Documents.tpl.php';
            if ($section) {
                $message .= " | section: {$section}";
            }
            $message .= ")";

            $object   = new ReflectionObject($e);
            $property = $object->getProperty('message');
            $property->setAccessible(true);
            $property->setValue($e, $message);

            $e->enhanced = true;
        }

        public function render(Array $vars = array(), $return = false)
        {
            try {
                return $this->_render($vars, $return);
            } catch (Exception $e) {
                if ($return) ob_get_clean();
                $this->enhanceException($e);
                throw $e;
            }
        }

        public function _render(Array $vars = array(), $return = false)
        {
            $this->context = $vars;

            extract($vars);
            if ($return) {
                ob_start();
            }

            echo "<?php\n\nnamespace ";
            echo trim($namespace, '\\') . ";\n\nuse MongoClient;\nuse ActiveMongo2\\Connection;\nuse Notoj\\Annotation\\Annotation;\nuse Notoj\\Annotation\\Annotations;\nuse Notoj;\n\n";
            foreach($collections->byName() as $name => $class) {

                $this->context['name'] = $name;
                $this->context['class'] = $class;
                echo "    define(";
                var_export('C' . $name);
                echo ", ";
                var_export($class['class']);
                echo ");\n";
            }
            echo "\n";
            $instance = '_' . uniqid(true);
            $this->context['instance'] = $instance;
            echo "\nclass Mapper\n{\n    protected \$mapper = ";
            echo crodas\FileUtil\dump_array($collections->byName(), true) . ";\n    protected \$class_mapper = ";
            echo crodas\FileUtil\dump_array($collections->byClass(), true) . ";\n    protected \$class_files =  ";
            var_export($collections->autoload());
            echo ";\n    protected static \$loaded = array();\n    protected \$connection;\n    protected \$connections;\n    protected \$class_connections = ";
            var_export($collections->byConnection());
            echo ";\n    protected \$ns = array();\n    protected \$ns_by_name = array();\n\n    public function __construct(Connection \$conn)\n    {\n        \$this->connection = \$conn;\n        spl_autoload_register(array(\$this, '__autoloader'));\n    }\n\n    public function setDatabases(Array \$conns, Array \$ns)\n    {\n        \$this->connections = \$conns;\n\n        \$this->ns = \$ns;\n        foreach (\$this->class_connections as \$class => \$conn) {\n            \$ns =\"\";\n            if (!empty(\$this->ns[\$conn])) {\n                \$ns = \$this->ns[\$conn];\n            }\n            if (!empty(\$this->class_mapper[\$class])) {\n                \$this->ns_by_name[ \$this->class_mapper[\$class]['name'] ] = \$ns;\n            }\n        }\n\n        return \$this;\n    }\n\n    public function getRelativePath(\$object, \$dir)\n    {\n        if (\$dir[0] == '/') {\n            return \$dir;\n        }\n        \$info = \$this->mapClass(\$object);\n        return \$info['dir'] . \"/\" . \$dir;\n    }\n\n    protected function array_diff(Array \$arr1, Array \$arr2)\n    {\n        \$diff = array();\n        foreach (\$arr1 as \$key => \$value) {\n            if (empty(\$arr2[\$key]) || \$arr2[\$key] !== \$arr1[\$key]) {\n                \$diff[\$key] = \$value;\n            }\n        }\n        return \$diff;\n    }\n\n    public function getCollections()\n    {\n        return array(\n";
            foreach($collections as $collection) {

                $this->context['collection'] = $collection;
                if ($collection->getName()) {
                    echo "                " . ($collection->getClassCode()) . " => \$this->ns_by_name[";
                    var_export($collection->getName());
                    echo "]. ";
                    var_export($collection->getName());
                    echo ",\n";
                }
            }
            echo "        );\n    }\n\n    public function __autoloader(\$class)\n    {\n        \$class = strtolower(\$class);\n        if (!empty(\$this->class_files[\$class])) {\n            self::\$loaded[\$this->class_files[\$class]] = true;\n            require \$this->class_files[\$class];\n\n            return true;\n        }\n        return false;\n    }\n\n    public function getCollectionObject(\$col)\n    {\n        if (!is_scalar(\$col) || empty(\$this->mapper[\$col])) {\n            \$data = \$this->mapClass(\$col);     \n        } else {\n            \$data = \$this->mapper[\$col];\n        }\n\n        if (empty(self::\$loaded[\$data['file']])) {\n            if (!\$data['verify'](\$data['class'], false)) {\n                require \$data['file'];\n            }\n            self::\$loaded[\$data['file']] = true;\n        }\n\n        \$data['name'] = \$this->ns_by_name[\$data['name']] . \$data['name'];\n\n        \$conn = \$this->class_connections[\$data['class']];\n\n        if (empty(\$this->connections[\$conn])) {\n            throw new \\RuntimeException(\"Cannot find connection \$conn. We have \" . print_r(array_keys(\$this->connections), true));\n        }\n\n        \$db = \$this->connections[\$conn];\n        if (!empty(\$data['is_gridfs'])) {\n            \$col = \$db->getGridFs(\$data['name']);\n        } else {\n            \$col = \$db->selectCollection(\$data['name']);\n        }\n\n        return [\$col, \$data['class']];\n    }\n\n    public function mapCollection(\$col)\n    {\n        \$col = strtolower(\$col);\n        if (empty(\$this->mapper[\$col])) {\n            throw new \\RuntimeException(\"Cannot map {\$col} collection to its class\");\n        }\n\n        \$data = \$this->mapper[\$col];\n\n        if (empty(self::\$loaded[\$data['file']])) {\n            if (!\$data['verify'](\$data['class'], false)) {\n                require \$data['file'];\n            }\n            self::\$loaded[\$data['file']] = true;\n        }\n\n        return \$data;\n    }\n\n    public function onQuery(\$table, &\$query)\n    {\n        if (!is_array(\$query)) {\n            if (\$query instanceof \\MongoId) {\n                \$query = ['_id' => \$query];\n            } else if (is_scalar(\$query)) {\n                if (is_numeric(\$query)) {\n                    \$query = ['_id' => [\n                        '\$in' => [\$query . '', 0+\$query],\n                    ]];\n                } else if (preg_match('/^[0-9a-f]{24}\$/i', \$query)) {\n                    \$query = ['_id' => [\n                        '\$in' => [\$query, new \\MongoId(\$query)],\n                    ]];\n                } else {\n                    \$query = ['_id' => \$query];\n                }\n            }\n        }\n\n        switch (\$table) {\n";
            foreach($collections as $collection) {

                $this->context['collection'] = $collection;
                echo "            case " . ($collection->getClassCode()) . ":\n";
                if ($collection->is('SingleCollection') && $collection->getParent()) {
                    echo "                    \$query[";
                    var_export($collection->getDiscriminator());
                    echo "] = " . ($collection->getClassCode()) . ";\n";
                }
                foreach($collection->getMethodsByAnnotation('onQuery') as $method) {

                    $this->context['method'] = $method;
                    echo "                    " . ($method->toCode($collection, '$query')) . "\n";
                }
                foreach($collection->getPlugins('onQuery') as $plugin) {

                    $this->context['plugin'] = $plugin;
                    echo "                    " . ($plugin->toCode($collection, '$query')) . "\n";
                }
                echo "            break;\n";
            }
            echo "        }\n    }\n\n    public function mapClass(\$class)\n    {\n        if (is_object(\$class)) {\n            \$class = \$this->get_class(\$class);\n        }\n\n        \$class = strtolower(\$class);\n        if (empty(\$this->class_mapper[\$class])) {\n";
            foreach($collections as $collection) {

                $this->context['collection'] = $collection;
                if ($collection->is('SingleCollection')) {
                    echo "                if (\$class == " . ($collection->getClassCode()) . " ||  \$class == ";
                    var_export($collection->getName());
                    echo "){\n                    return ";
                    var_export(['name' => $collection->getName(), 'dynamic' => true, 'prop' => $collection->getDiscriminator(), 'class' => NULL]);
                    echo ";\n                }\n";
                }
            }
            echo "            throw new \\RuntimeException(\"Cannot map class {\$class} to its document\");\n        }\n\n        \$data = \$this->class_mapper[\$class];\n\n        if (empty(self::\$loaded[\$data['file']])) {\n            if (!\$data['verify'](\$data['class'], false)) {\n                require \$data['file'];\n            }\n            self::\$loaded[\$data['file']] = true;\n        }\n\n        return \$data;\n    }\n\n    protected function is_array(\$array)\n    {\n        if (is_array(\$array)) {\n            \$keys = array_keys(\$array);\n            \$expected = range(0, count(\$array)-1);\n            return count(array_diff(\$keys, \$expected)) == 0;\n        }\n        return false;\n    }\n\n    protected function array_unique(\$array, \$toRemove)\n    {\n        \$return = array();\n        \$count  = array();\n        foreach (\$array as \$key => \$value) {\n            \$val = serialize(\$value);\n            if (empty(\$count[\$val])) {\n                \$count[\$val] = 0;\n            }\n            \$count[\$val]++; \n        }\n        foreach (\$toRemove as \$value) {\n            \$val = serialize(\$value);\n            if (!empty(\$count[\$val]) && \$count[\$val] != 1) {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    public function mapObject(\$object)\n    {\n        \$class = strtolower(\$this->get_class(\$object));\n        if (empty(\$this->class_mapper[\$class])) {\n            throw new \\RuntimeException(\"Cannot map class {\$class} to its document\");\n        }\n\n        return \$this->class_mapper[\$class];\n    }\n\n    public function getReflection(\$name)\n    {\n        \$class = strtolower(\$name);\n        if (empty(\$this->class_mapper[\$class])) {\n            if (empty(\$this->mapper[\$name])) {\n                throw new \\RuntimeException(\"Cannot map class {\$class} to its document\");\n            }\n            \$class = \$this->mapper[\$name]['class'];\n        }\n\n        return new \\ActiveMongo2\\Reflection\\Collection(\$this->{\"reflect_\" . sha1(\$class)}(), \$this);\n    }\n\n    public function getReference(\$object, Array \$extra = array())\n    {\n        \$class = strtolower(\$this->get_class(\$object));\n        if (empty(\$this->class_mapper[\$class])) {\n            throw new \\RuntimeException(\"Cannot map class {\$class} to its document\");\n        }\n        return \$this->{\"get_reference_\" . sha1(\$class)}(\$object, \$extra);\n    }\n\n    public function populateFromArray(\$object, Array \$data)\n    {\n        \$class = strtolower(\$this->get_class(\$object));\n        if (empty(\$this->class_mapper[\$class])) {\n            throw new \\RuntimeException(\"Cannot map class {\$class} to its document\");\n        }\n\n        return \$this->{\"populate_from_array_\" . sha1(\$class)}(\$object, \$data);\n    }\n\n\n    public function getDocument(\$object)\n    {\n        if (\$object instanceof \\ActiveMongo2\\Reference) {\n            \$object = \$object->getObject();\n        }\n        \$class = strtolower(\$this->get_class(\$object));\n        if (empty(\$this->class_mapper[\$class])) {\n            throw new \\RuntimeException(\"Cannot map class {\$class} to its document\");\n        }\n\n        return \$this->{\"get_array_\" . sha1(\$class)}(\$object);\n    }\n\n    public function validate(\$object)\n    {\n        \$old   = \$this->getRawDocument(\$object);\n        \$class = strtolower(\$this->get_class(\$object));\n        if (empty(\$this->class_mapper[\$class])) {\n            throw new \\RuntimeException(\"Cannot map class {\$class} to its document\");\n        }\n\n        return \$this->{\"validate_\" . sha1(\$class)}(\$object, \$old);\n    }\n\n    public function set_property(\$object, \$name, \$value)\n    {\n        \$class = strtolower(\$this->get_class(\$object));\n        if (empty(\$this->class_mapper[\$class])) {\n            throw new \\RuntimeException(\"Cannot map class {\$class} to its document\");\n        }\n\n        return \$this->{\"set_property_\" . sha1(\$class)}(\$object, \$name, \$value);\n    }\n\n    public function get_property(\$object, \$name)\n    {\n        \$class = strtolower(\$this->get_class(\$object));\n        if (empty(\$this->class_mapper[\$class])) {\n            throw new \\RuntimeException(\"Cannot map class {\$class} to its document\");\n        }\n\n        return \$this->{\"get_property_\" . sha1(\$class)}(\$object, \$name);\n    }\n\n    public function update(\$object, Array &\$doc, Array \$old)\n    {\n        \$class = strtolower(\$this->get_class(\$object));\n        if (empty(\$this->class_mapper[\$class])) {\n            throw new \\RuntimeException(\"Cannot map class {\$class} to its document\");\n        }\n\n        return \$this->{\"update_\" . sha1(\$class)}(\$doc, \$old);\n    }\n\n    public function getRawDocument(\$object)\n    {\n        if (!empty(\$object->";
            echo $instance . ") && \$object->" . ($instance) . " instanceof ActiveMongo2Mapped) {\n            return \$object->";
            echo $instance . "->getOriginal();\n        }\n\n        return array();\n    }\n\n    public function populate(&\$object, \$data)\n    {\n        \$class = strtolower(\$this->get_class(\$object));\n\n        if (empty(\$this->class_mapper[\$class])) {\n            throw new \\RuntimeException(\"Cannot map class {\$class} to its document\");\n        }\n\n        return \$this->{\"populate_\" . sha1(\$class)}(\$object, \$data);\n    }\n\n    public function trigger(\$w, \$event, \$object, Array \$args = array())\n    {\n        if (!\$w) return;\n        if (\$object instanceof \\ActiveMongo2\\Reference) {\n            \$class = strtolower(\$object->getClass());\n        } else {\n            \$class = strtolower(\$this->get_class(\$object));\n        }\n        \$method = \"event_{\$event}_\" . sha1(\$class);\n        if (!is_callable(array(\$this, \$method))) {\n            return;\n        }\n\n        return \$this->\$method(\$object, \$args);\n    }\n\n    public function getMapping(\$class)\n    {\n        if (is_object(\$class)) {\n            \$class = \$this->get_class(\$class);\n        }\n        \$func  = \"get_mapping_\" . sha1(\$class);\n        if (!is_callable(array(\$this, \$func))) {\n            throw new \\Exception(\"Cannot map \$class\");\n        }\n        return \$this->\$func();\n    }\n\n    public function getObjectClass(\$col, \$doc)\n    {\n        if (\$doc instanceof \\MongoGridFsFile) {\n            \$doc = \$doc->file;\n        }\n        if (\$col instanceof \\MongoCollection) {\n            \$col = \$col->getName();\n        }\n\n        \$class = NULL;\n        switch (\$col) {\n";
            foreach($collections as $collection) {

                $this->context['collection'] = $collection;
                if ($collection->is('GridFs')) {
                    echo "            case \$this->ns_by_name[";
                    var_export($collection->getname());
                    echo "] . ";
                    var_export($collection->getName() . '.files');
                    echo ":\n            case \$this->ns_by_name[";
                    var_export($collection->getname());
                    echo "] . ";
                    var_export($collection->getName() . '.chunks');
                    echo ":\n            case ";
                    var_export($collection->getName() . '.files');
                    echo ":\n            case ";
                    var_export($collection->getName() . '.chunks');
                    echo ":\n";
                }
                else {
                    if ($collection->getName()) {
                        echo "                case \$this->ns_by_name[";
                        var_export($collection->getname());
                        echo "] . ";
                        var_export($collection->getName());
                        echo ":\n";
                    }
                    echo "            case ";
                    var_export($collection->getName());
                    echo ":\n";
                }
                if (!$collection->is('SingleCollection')) {
                    echo "                    \$class = " . ($collection->getClassCode()) . ";\n";
                }
                else {
                    echo "                    if (!empty(" . ($collection->getDiscriminator(true)->getPHPVariable()) . ")) {\n                        \$class = ";
                    echo $collection->getDiscriminator(true)->getPHPVariable() . ";\n                    }\n";
                }
                echo "                break;\n";
            }
            echo "        }\n\n        if (empty(\$class)) {\n            throw new \\RuntimeException(\"Cannot get class for collection {\$col}\");\n        }\n\n        return \$class;\n    }\n\n    public function get_class(\$object)\n    { \n        if (\$object instanceof \\ActiveMongo2\\Reference) {\n            \$class = \$object->getClass();\n        } else {\n            \$class = strtolower(get_class(\$object));\n        }\n\n        return \$class;\n    }\n\n    public function updateProperty(\$document, \$key, \$value)\n    {\n        \$class  = strtolower(\$this->get_class(\$document));\n        \$method = \"update_property_\" . sha1(\$class);\n        if (!is_callable(array(\$this, \$method))) {\n            throw new \\RuntimeException(\"Cannot trigger {\$event} event on '\$class' objects\");\n        }\n\n        return \$this->\$method(\$document, \$key, \$value);\n    }\n\n    public function ensureIndex(\$background)\n    {\n\n";
            $is_new = version_compare(MongoClient::VERSION, '1.5.0', '>');
            $this->context['is_new'] = $is_new;
            echo "\n";
            foreach($collections->getIndexes() as $id => $index) {

                $this->context['id'] = $id;
                $this->context['index'] = $index;
                $next = uniqid(true);
                $this->context['next'] = $next;
                if (!empty($index['col'])) {
                    $col = $index['col'];
                    $this->context['col'] = $col;
                }
                else {
                    $col = $index['prop']->getParent();
                    $this->context['col'] = $col;
                }
                echo "\n            \$conn = \$this->class_connections[";
                var_export($col->getClass());
                echo "];\n            if (empty(\$this->connections[\$conn])) {\n                goto skip_";
                echo $next . ";\n            }\n            \$db = \$this->connections[\$conn];\n\n        try {\n            \$col = \$db->createCollection(\$this->ns_by_name[";
                var_export($col->getName());
                echo "] . ";
                var_export($col->getName());
                echo ", []); \n\n";
                if ($is_new) {
                    echo "            \$return = \$col->createIndex(\n                ";
                    echo crodas\FileUtil\dump_array($index['field']);
                    echo ",\n                ";
                    echo crodas\FileUtil\dump_array($index['extra']);
                    echo "\n            );\n";
                }
                else {
                    echo "            \$return = \$col->ensureIndex(\n                ";
                    echo crodas\FileUtil\dump_array($index['field']);
                    echo ",\n                ";
                    echo crodas\FileUtil\dump_array($index['extra']);
                    echo "\n            );\n";
                }
                echo "        } catch (\\MongoException \$e) {\n            // delete index and try to rebuild it\n            \$col->deleteIndex(";
                echo crodas\FileUtil\dump_array($index['field']);
                echo ");\n\n";
                if ($is_new) {
                    echo "            \$col->createIndex(\n                ";
                    echo crodas\FileUtil\dump_array($index['field']);
                    echo ",\n                ";
                    echo crodas\FileUtil\dump_array($index['extra']);
                    echo "\n            );\n";
                }
                else {
                    echo "            \$col->ensureIndex(\n                ";
                    echo crodas\FileUtil\dump_array($index['field']);
                    echo ",\n                ";
                    echo crodas\FileUtil\dump_array($index['extra']);
                    echo "\n            );\n";
                }
                echo "        }\n        skip_";
                echo $next . ":\n";
            }
            echo "    }\n\n";
            foreach($collections as $collection) {

                $this->context['collection'] = $collection;
                echo "\n    /**\n     *  ";
                echo $collection->getClass() . " => " . ($collection->GetName()) . "\n     *  ";
                echo count($collection->getAnnotation()->getAnnotations()) . "\n     */\n    protected function set_property_";
                echo sha1($collection->getClass()) . "(\$object, \$name, \$value)\n    {\n        switch (\$name) {\n";
                foreach($collection->getProperties() as $prop) {

                    $this->context['prop'] = $prop;
                    echo "        case ";
                    var_export($prop->getPHPName());
                    echo ":\n        case ";
                    var_export($prop->getName());
                    echo ":\n";
                    if ($prop->isPublic()) {
                        echo "                \$object->" . ($prop->getPHPName()) . " = \$value;\n";
                    }
                    else {
                        echo "                \$property = new \\ReflectionProperty(\$object, ";
                        var_export($prop->getPHPName());
                        echo ");\n                \$property->setAccessible(true);\n                \$property->setValue(\$object, \$value);\n";
                    }
                    echo "            break;\n";
                }
                echo "        default:\n            throw new \\RuntimeException(\"Missing property {\$name}\");\n        }\n\n        return true;\n    }\n\n    /**\n     *  Populate from \$_POST for collection ";
                echo $collection->GetClass() . "\n     */\n    protected function populate_from_array_";
                echo sha1($collection->getClass()) . "(\$object, Array \$data)\n    {\n";
                if ($collection->GetName()) {
                    echo "        if (array_key_exists(";
                    var_export($collection->GetName());
                    echo ", \$data)) {\n            \$data = \$data[";
                    var_export($collection->getName());
                    echo "];\n        }\n";
                }
                echo "        \n";
                if ($collection->GetParent()) {
                    echo "        // populate parent data first\n        \$this->populate_from_array_";
                    echo sha1($collection->GetParent()->getClass()) . "(\$object, \$data);\n";
                }
                echo "\n";
                foreach($collection->getProperties() as $prop) {

                    $this->context['prop'] = $prop;
                    if ($prop->isId() || $prop->getAnnotation()->has('ReferenceMany,EmbedMany')) {
                        echo "                // we cannot handle " . ($prop->GetName()) . " at the moment\n";
                        continue;
                    }
                    echo "\n";
                    foreach(array_unique([$prop->getName(), $prop->getPHPName()]) as $var) {

                        $this->context['var'] = $var;
                        echo "\n            if (array_key_exists(";
                        var_export($var);
                        echo ", \$data)) {\n                \$value = \$data[";
                        var_export($var);
                        echo "];\n";
                        if ($xcol = $prop->getReferenceCollection()) {
                            $xclass = $collections->ByName()[$xcol]['class'];
                            $this->context['xclass'] = $xclass;
                            if ($xclass) {
                                echo "                        if (!is_array(\$value)) {\n                            throw new \\RuntimeException(\"";
                                var_export($prop->getName());
                                echo " must be an array\");\n                        }\n                        if (";
                                var_export($prop->getType() == 'Reference');
                                echo " && !empty(\$value['_id'])) {\n                            \$value = \$this->connection->getCollection(";
                                var_export($xcol);
                                echo ")\n                                ->findOne(\$value['_id']);\n                        } else {\n";
                                if ($prop->isPublic()) {
                                    echo "                                \$oldValue = \$object->" . ($prop->getPHPName()) . ";\n";
                                }
                                else {
                                    echo "                                \$property = new \\ReflectionProperty(\$object, ";
                                    var_export($var);
                                    echo ");\n                                \$property->setAccessible(true);\n                                \$oldValue = \$property->getValue(\$object);\n";
                                }
                                echo "                            \$docValue =  \$oldValue ?: new \\" . ($xclass) . ";\n                            \$this->populate_from_array_";
                                echo sha1($xclass) . "(\$docValue, \$value);\n                            \$value = \$docValue;\n                        }\n";
                            }
                        }
                        echo "\n";
                        if ($prop->isPublic()) {
                            echo "                    \$object->" . ($prop->getPHPName()) . " = \$value; \n";
                        }
                        else {
                            echo "                    \$property = new \\ReflectionProperty(\$object, ";
                            var_export($prop->getPHPName());
                            echo ");\n                    \$property->setAccessible(true);\n                    \$property->setValue(\$object, \$value);\n";
                        }
                        echo "    \n            }\n";
                    }
                }
                echo "    }\n\n\n    protected function get_property_";
                echo sha1($collection->getClass()) . "(\$object, \$name)\n    {\n        switch (\$name) {\n";
                foreach($collection->getProperties() as $prop) {

                    $this->context['prop'] = $prop;
                    echo "        case ";
                    var_export($prop->getPHPName());
                    echo ":\n        case ";
                    var_export($prop->getName());
                    echo ":\n";
                    if ($prop->isPublic()) {
                        echo "                \$return = \$object->" . ($prop->getPHPName()) . ";\n";
                    }
                    else {
                        echo "                \$property = new \\ReflectionProperty(\$object, ";
                        var_export($prop->getPHPName());
                        echo ");\n                \$property->setAccessible(true);\n                \$return = \$property->getValue(\$object);\n";
                    }
                    echo "            break;\n";
                }
                echo "        case '_id': \n            //fallback to get the object ID when it is not part of the object (rare case)\n            if (!empty(\$object->";
                echo $instance . ") && \$object->" . ($instance) . " instanceof ActiveMongo2Mapped) {\n                return \$object->";
                echo $instance . "->getOriginal()['_id'];\n            }\n        default:\n";
                if ($collection->getParent()) {
                    echo "                return \$this->get_property_" . (sha1($collection->getParent())) . "(\$object, \$name);\n";
                }
                else {
                    echo "                throw new \\RuntimeException(\"Missing property {\$name}\");\n";
                }
                echo "        }\n\n        return \$return;\n    }\n\n    /**\n     *  Get update object ";
                echo $collection->getClass() . " \n     */\n    protected function update_";
                echo sha1($collection->getClass()) . "(Array &\$current, Array \$old, \$embed = false)\n    {\n        if (!\$embed && !empty(\$current['_id']) && \$current['_id'] != \$old['_id']) {\n            throw new \\RuntimeException(\"document ids cannot be updated\");\n        }\n\n";
                if (!$collection->getParent()) {
                    echo "            \$change = array();\n";
                }
                else {
                    echo "            \$change = \$this->update_" . (sha1($collection->getParent())) . "(\$current, \$old, \$embed);\n";
                }
                echo "\n";
                foreach($collection->getProperties() as $prop) {

                    $this->context['prop'] = $prop;
                    echo "            \$has_changed = false;\n            if (array_key_exists(";
                    var_export($prop.'');
                    echo ", " . ($prop->getPHPBaseVariable('$current')) . ")\n                || array_key_exists(";
                    var_export($prop.'');
                    echo ", \$old)) {\n                if (!array_key_exists(";
                    var_export($prop.'');
                    echo ", " . ($prop->getPHPBaseVariable('$current')) . ")) {\n                    \$change['\$unset'][";
                    var_export($prop.'');
                    echo "] = 1;\n                } else if (!array_key_exists(";
                    var_export($prop.'');
                    echo ", \$old)) {\n                    \$change['\$set'][";
                    var_export($prop.'');
                    echo "] = " . ($prop->getPHPVariable('$current')) . ";\n                    \$has_changed = true;\n                } else if (";
                    echo $prop->getPHPVariable('$current') . " !== \$old[";
                    var_export($prop.'');
                    echo "]) {\n                    \$has_changed = true;\n";
                    if ($prop->getAnnotation()->has('Inc')) {
                        echo "                        if (empty(\$old[";
                        var_export($prop.'');
                        echo "])) {\n                            \$prev = 0;\n                        } else {\n                            \$prev = \$old[";
                        var_export($prop.'');
                        echo "];\n                        }\n                        \$change['\$inc'][";
                        var_export($prop.'');
                        echo "] = " . ($prop->GetPHPVariable('$current')) . " - \$prev;\n";
                    }
                    else if ($prop->getAnnotation()->has('Embed')) {
                        echo "                        if (" . ($prop->getPHPVariable('$current')) . "['__embed_class'] != \$old[";
                        var_export($prop.'');
                        echo "]['__embed_class']) {\n                            \$change['\$set'][";
                        var_export($prop.'.');
                        echo " . \$index] = " . ($prop->GetPHPVariable('$current')) . ";\n                        } else {\n                            \$update = 'update_' . sha1(";
                        echo $prop->getPHPVariable('$current') . "['__embed_class']);\n                            \$diff = \$this->\$update(";
                        echo $prop->getPHPVariable('$current') . ", \$old[";
                        var_export($prop.'');
                        echo "], true);\n                            foreach (\$diff as \$op => \$value) {\n                                foreach (\$value as \$p => \$val) {\n                                    \$change[\$op][";
                        var_export($prop.'.');
                        echo " . \$p] = \$val;\n                                }\n                            }\n                        }\n";
                    }
                    else if ($prop->getAnnotation()->has('EmbedMany')) {
                        echo "                        // add things to the array\n                        \$toRemove = array_diff_key(\$old[";
                        var_export($prop.'');
                        echo "], " . ($prop->getPHPVariable('$current')) . ");\n\n                        if (count(\$toRemove) > 0 && \$this->array_unique(\$old[";
                        var_export($prop.'');
                        echo "], \$toRemove)) {\n                            \$change['\$set'][";
                        var_export($prop.'');
                        echo "] = array_values(" . ($prop->getPHPVariable('$current')) . ");\n                        } else {\n                            foreach (";
                        echo $prop->getPHPVariable('$current') . " as \$index => \$value) {\n                                if (!array_key_exists(\$index, \$old[";
                        var_export($prop.'');
                        echo "])) {\n                                    \$change['\$push'][";
                        var_export($prop.'');
                        echo "]['\$each'][] = \$value;\n                                    continue;\n                                }\n                                if (\$value['__embed_class'] != \$old[";
                        var_export($prop.'');
                        echo "][\$index]['__embed_class']) {\n                                    \$change['\$set'][";
                        var_export($prop.'.');
                        echo " . \$index] = \$value;\n                                } else {\n                                    \$update = 'update_' . sha1(\$value['__embed_class']);\n                                    \$diff = \$this->\$update(\$value, \$old[";
                        var_export($prop.'');
                        echo "][\$index], true);\n                                    foreach (\$diff as \$op => \$value) {\n                                        foreach (\$value as \$p => \$val) {\n                                            \$change[\$op][";
                        var_export($prop.'.');
                        echo " . \$index . '.' . \$p] = \$val;\n                                        }\n                                    }\n                                }\n                            }\n\n                            foreach (\$toRemove as \$value) {\n                                if (!empty(\$value['__instance'])) {\n                                    \$change['\$pull'][";
                        var_export($prop.'');
                        echo "]['__instance']['\$in'][] = \$value['__instance'];\n                                } else {\n                                    \$change['\$pull'][";
                        var_export($prop.'');
                        echo "][] = \$value;\n                                }\n                            }\n                        }\n";
                    }
                    else if ($prop->getAnnotation()->has('ReferenceMany,Array')) {
                        echo "                        // add things to the array\n                        \$toRemove = array_diff_key(\$old[";
                        var_export($prop.'');
                        echo "], " . ($prop->getPHPVariable('$current')) . ");\n\n                        if ((count(\$toRemove) > 0 && \$this->array_unique(\$old[";
                        var_export($prop.'');
                        echo "], \$toRemove)) || !\$this->is_array(\$old[";
                        var_export($prop.'');
                        echo "])) {\n                            \$change['\$set'][";
                        var_export($prop.'');
                        echo "] = array_values(" . ($prop->getPHPVariable('$current')) . ");\n                        } else {\n                            foreach (";
                        echo $prop->getPHPVariable('$current') . " as \$index => \$value) {\n                                if (!array_key_exists(\$index, \$old[";
                        var_export($prop.'');
                        echo "])) {\n";
                        if ($prop->getAnnotation()->has('ReferenceMany')) {
                            echo "                                        \$change['\$addToSet'][";
                            var_export($prop.'');
                            echo "]['\$each'][] = \$value;\n";
                        }
                        else {
                            echo "                                        \$change['\$push'][";
                            var_export($prop.'');
                            echo "]['\$each'][] = \$value;\n";
                        }
                        echo "                                    continue;\n                                }\n\n                                if (!empty(\$old[";
                        var_export($prop.'');
                        echo "][\$index]['__instance']) && is_array(\$value)) {\n                                    // __instance is an internal variable that helps\n                                    // activemongo2 to remove sub objects from arrays easily.\n                                    // Its value is private to the library and it shouldn't change\n                                    // unless the value of the object changes\n                                    \$diff = \$this->array_diff(\n                                        \$value,\n                                        \$old[";
                        var_export($prop.'');
                        echo "][\$index]\n                                    );\n                                    if (count(\$diff) == 1 && !empty(\$diff['__instance'])) {\n                                        \$value['__instance'] = \$old[";
                        var_export($prop.'');
                        echo "][\$index]['__instance'];\n                                        ";
                        echo $prop->getPHPVariable('$current') . "[\$index] = \$value;\n                                    }\n                                }\n\n                                if (\$old[";
                        var_export($prop.'');
                        echo "][\$index] != \$value) {\n                                    \$change['\$set'][";
                        var_export($prop . '.');
                        echo " . \$index] = \$value;\n                                }\n                            }\n\n                            foreach (\$toRemove as \$value) {\n                                if (!empty(\$value['__instance'])) {\n                                    \$change['\$pull'][";
                        var_export($prop.'');
                        echo "]['__instance']['\$in'][] = \$value['__instance'];\n                                } else {\n                                    \$change['\$pull'][";
                        var_export($prop.'');
                        echo "] = \$value;\n                                }\n                            }\n                        }\n";
                    }
                    else {
                        echo "                        \$change['\$set'][";
                        var_export($prop.'');
                        echo "] = " . ($prop->getPHPVariable('$current')) . ";\n";
                    }



                    echo "                }\n            }\n\n";
                    $ann = $prop->getAnnotation();
                    $this->context['ann'] = $ann;
                    if ($ann->has('Array,ReferenceMany,EmbedMany')) {
                        if ($ann->has('Limit')) {
                            echo "                if (\$has_changed && !empty(\$change['\$push'][";
                            var_export($prop.'');
                            echo "])) {\n                    \$change['\$push'][";
                            var_export($prop.'');
                            echo "]['\$slice'] = ";
                            var_export(0+current($prop->getAnnotation()->getOne('Limit')->getArgs()));
                            echo ";\n                }\n";
                        }
                        if ($ann->has('Sort')) {
                            echo "                if (\$has_changed && !empty(\$change['\$push'][";
                            var_export($prop.'');
                            echo "])) {\n                    \$change['\$sort'][";
                            var_export($prop.'');
                            echo "]['\$sort'] = ";
                            var_export(0+current($prop->getAnnotation()->getOne('Limit')->getArgs()));
                            echo ";\n                }\n";
                        }
                    }
                }
                echo "\n        return \$change;\n    }\n\n    protected function get_mapping_";
                echo sha1($collection->getClass()) . "() \n    {\n        return array(\n";
                foreach($collection->getProperties() as $prop) {

                    $this->context['prop'] = $prop;
                    echo "                ";
                    var_export($prop->getName(true));
                    echo " => ";
                    var_export($prop->getProperty());
                    echo ",\n";
                }
                echo "        );\n    }\n\n    /**\n     *  Populate objects ";
                echo $collection->getClass() . " \n     */\n    protected function populate_";
                echo sha1($collection->getClass()) . "(\\" . ($collection->getClass()) . " &\$object, \$data)\n    {\n";
                if ($p = $collection->getParent()) {
                    echo "            \$this->populate_" . (sha1($p->getClass())) . "(\$object, \$data);\n";
                }
                echo "\n";
                if ($collection->is('GridFs')) {
                    echo "            if (!\$data instanceof \\MongoGridFsFile) {\n                throw new \\RuntimeException(\"Internal error, trying to populate a GridFSFile with an array\");\n            }\n            \$data_file = \$data;\n            \$data      = \$data->file;\n            if (empty(\$data['metadata'])) {\n                \$data['metadata'] = [];\n            }\n";
                    foreach(array("length", "chunkSize", "md5", "uploadDate") as $key) {

                        $this->context['key'] = $key;
                        echo "                \$data['metadata'][";
                        var_export($key);
                        echo "] = \$data[";
                        var_export($key);
                        echo "];\n";
                    }
                }
                else {
                    echo "\n            if (!is_array(\$data)) {\n                throw new \\RuntimeException(\"Internal error, trying to populate a document with a wrong data\");\n            }\n";
                }
                echo "\n        \$doc = \$data;\n\n";
                foreach($collection->getProperties() as $prop) {

                    $this->context['prop'] = $prop;
                    if ($prop->getAnnotation()->has('ReferenceMany')) {
                        echo "                if (!empty(" . ($prop->getPHPVariable()) . ")) {\n                    foreach(";
                        echo $prop->getPHPVariable() . " as \$id => \$sub) {\n                        if (empty(\$sub['__instance']) || !strpos(\$sub['__instance'], \$sub['\$ref'])) {\n                            \$sub['__instance'] = \$sub['\$ref'] . ':' . serialize(\$sub['\$id']) ;\n                        }\n                        ";
                        echo $prop->getPHPVariable() . "[\$id] = \$sub;\n                    }\n                }\n";
                    }
                    else if ($prop->getAnnotation()->has('Stream')) {
                        if ($prop->isPublic()) {
                            echo "                    \$object->" . ($prop->getPHPName()) . " = \$data_file->getResource();\n";
                        }
                        else {
                            echo "                    \$property = new \\ReflectionProperty(\$object, ";
                            var_export($prop->getPHPName());
                            echo ");\n                    \$property->setAccessible(true);\n                    \$property->setValue(\$object, \$data_file->getResource());\n";
                        }
                        continue;
                    }

                    echo "\n            if (array_key_exists(";
                    var_export($prop.'');
                    echo ", " . ($prop->getPHPBaseVariable()) . ")) {\n";
                    foreach($prop->getCallback('Hydratate') as $h) {

                        $this->context['h'] = $h;
                        echo "                    " . ($h->toCode($prop, $prop->getPHPVariable())) . "\n";
                    }
                    echo "\n";
                    if ($prop->isPublic()) {
                        echo "                    \$object->" . ($prop->getPHPName()) . " = " . ($prop->getPHPVariable()) . ";\n";
                    }
                    else {
                        echo "                    \$property = new \\ReflectionProperty(\$object, ";
                        var_export($prop->getPHPName());
                        echo ");\n                    \$property->setAccessible(true);\n                    \$property->setValue(\$object, ";
                        echo $prop->getPHPVariable() . ");\n";
                    }
                    echo "                \n            }\n";
                }
                echo "\n        if (empty(\$object->";
                echo $instance . ")) {\n            \$object->";
                echo $instance . " = new ActiveMongo2Mapped(" . ($collection->getClassCode()) . ", \$data);\n        } else {\n            \$object->";
                echo $instance . "->" . ($instance) . "_setOriginal(\$data);\n        }\n    }\n\n    /**\n     *  Get reference of  ";
                echo $collection->getClass() . " object\n     */\n    protected function get_reference_";
                echo sha1($collection->getClass()) . "(\\" . ($collection->getClass()) . " \$object, \$include = Array())\n    {\n        \$document = \$this->get_array_";
                echo sha1($collection->getClass()) . "(\$object);\n        \$extra    = array();\n        if (\$include) {\n            \$extra  = array_intersect_key(\$document, \$include);\n        }\n\n";
                if ($cache = $collection->getRefCache()) {
                    echo "            \$extra = array_merge(\$extra,  array_intersect_key(\n                \$document, \n                ";
                    var_export($cache);
                    echo "\n            ));\n";
                }
                echo "        \n        foreach (\$extra as \$key => \$value) {\n            if (is_object(\$value)) {\n                if (\$value instanceof \\ActiveMongo2\\Reference) {\n                    \$extra[\$key] = \$value->getReference();\n                } else {\n                    \$extra[\$key] = \$this->getReference(\$value);\n                }\n            }\n        }\n\n        return array_merge(array(\n                '\$ref'  => ";
                var_export($collection->getName());
                echo ", \n                '\$id'   => \$document['_id'],\n                '__class' => ";
                echo $collection->getClassCode() . ",\n                '__instance' => ";
                var_export($collection->getName());
                echo " . ':' . serialize(\$document['_id']),\n            )\n            , \$extra\n        );\n\n    }\n\n    /**\n     *  Validate ";
                echo $collection->getClass() . " object\n     */\n    protected function get_array_";
                echo sha1($collection) . "(\\" . ($collection) . " \$object, \$recursive = true)\n    {\n";
                if (!$collection->getParent()) {
                    echo "            \$doc = array();\n";
                }
                else {
                    echo "            \$doc = \$recursive ? \$this->get_array_" . (sha1($collection->getParent())) . "(\$object) : array();\n";
                }
                echo "\n";
                foreach($collection->getProperties() as $prop) {

                    $this->context['prop'] = $prop;
                    if ($prop->isPublic() && !$prop->isCustom()) {
                        echo "                /* Public property " . ($prop->getPHPName()) . " -> " . ($prop->getName()) . " */\n                if (\$object->";
                        echo $prop->getPHPName() . " !== NULL) {\n                    ";
                        echo $prop->getPHPVariable() . " = \$object->" . ($prop->getPHPName()) . ";\n                }\n";
                    }
                    else if ($prop->isCustom()) {
                        echo "                /* public and custom property " . ($prop->getPHPName()) . " -> " . ($prop->getName()) . " */\n                if (!empty(\$object->";
                        echo $prop->getPHPName() . ")) {\n                    ";
                        echo $prop->getPHPVariable() . " = \$object->" . ($prop->getPHPName()) . ";\n                }\n";
                    }
                    else {
                        echo "                \$property = new \\ReflectionProperty(\$object, ";
                        var_export($prop->getPHPName());
                        echo ");\n                \$property->setAccessible(true);\n                \$value = \$property->getValue(\$object);\n                if (\$value !== NULL) {\n                    ";
                        echo $prop->getPHPVariable() . " = \$value;\n                }\n";
                    }

                }
                echo "\n";
                foreach($collection->getProperties() as $prop) {

                    $this->context['prop'] = $prop;
                    foreach($prop->getCallback('DefaultValue') as $default) {

                        $this->context['default'] = $default;
                        echo "                if (empty(" . ($prop->getPHPVariable()) . ")) {\n                    ";
                        echo $default->toCode($prop) . "\n                    ";
                        echo $prop->getPHPVariable() . " = \$return;\n                }\n";
                    }
                }
                echo "\n";
                if ($collection->is('SingleCollection')) {
                    echo "            // SINGLE COLLECTION\n            ";
                    echo $collection->getDiscriminator(true)->getPHPVariable() . " = " . ($collection->getClassCode()) . ";\n";
                }
                echo "\n        if (empty(\$doc['_id'])) {\n            \$oldDoc = \$this->getRawDocument(\$object, false);\n            if (!empty(\$oldDoc['_id'])) {\n                \$doc['_id'] = \$oldDoc['_id'];\n            }\n        }\n\n        return \$doc;\n    }\n\n    protected function reflect_";
                echo sha1($collection->getClass()) . "() \n    {\n        \$reflection = array(\n            'class'    => ";
                echo $collection->getClassCode() . ",\n            'name'     => ";
                var_export($collection->getName());
                echo ",\n            'collection'     => ";
                var_export($collection->getName());
                echo ",\n            'annotation' => array(\n";
                foreach($collection->getAnnotation()->getAnnotations() as $ann) {

                    $this->context['ann'] = $ann;
                    echo "            new Annotation(";
                    var_export($ann->getName());
                    echo ", ";
                    var_export($collection->serializeAnnArgs($ann));
                    echo "),\n";
                }
                echo "            ),\n            'properties'  => array(\n";
                foreach($collection->getProperties() as $prop) {

                    $this->context['prop'] = $prop;
                    echo "            ";
                    var_export($prop->getPHPName());
                    echo " => new \\ActiveMongo2\\Reflection\\Property(array(\n                'property' => ";
                    var_export($prop.'');
                    echo ",\n                'type'     => ";
                    var_export($prop->getType());
                    echo ",\n";
                    if ($prop->getReferenceCollection()) {
                        echo "                'collection' => ";
                        var_export($prop->getReferenceCollection());
                        echo ",\n";
                    }
                    echo "                'annotation' => new Annotations(array(\n";
                    foreach($prop->getAnnotation()->getAnnotations() as $ann) {

                        $this->context['ann'] = $ann;
                        echo "                    new Annotation(";
                        var_export($ann->getName());
                        echo ", ";
                        var_export($collection->serializeAnnArgs($ann));
                        echo "),\n";
                    }
                    echo "                )),\n            ), \$this),\n";
                }
                echo "        ));\n\n";
                if ($collection->getParent()) {
                    echo "            \$reflection['properties'] = array_merge(\n                \$this->reflect_";
                    echo sha1($collection->GetParent()) . "()['properties'], \n                \$reflection['properties']\n            );\n";
                }
                echo "        return \$reflection;\n    }\n\n    /**\n     *  Validate ";
                echo $collection->getClass() . " object\n     */\n    protected function validate_";
                echo sha1($collection->getClass()) . "(\\" . ($collection->getClass()) . " \$object, Array \$old)\n    {\n";
                if ($collection->getParent()) {
                    echo "            \$doc = array_merge(\n                \$this->validate_";
                    echo sha1($collection->getParent()) . "(\$object, \$old),\n                \$this->get_array_";
                    echo sha1($collection->getClass()) . "(\$object, false)\n            );\n";
                }
                else {
                    echo "            \$doc = \$this->get_array_" . (sha1($collection->getClass())) . "(\$object);\n";
                }
                echo "\n";
                foreach($collection->getProperties() as $prop) {

                    $this->context['prop'] = $prop;
                    if ($prop->getAnnotation()->has('Required')) {
                        echo "            if (empty(" . ($prop->getPHPVariable()) . ")) {\n                throw new \\RuntimeException(\"";
                        echo $prop.'' . " cannot be empty\");\n            }\n";
                    }
                    echo "            if (!empty(" . ($prop->getPHPVariable()) . ") &&\n                   (empty(";
                    echo $prop->getPHPVariable('$old') . ") ||\n                    ";
                    echo $prop->getPHPVariable() . " !== " . ($prop->getPHPVariable('$old')) . " )) {\n                                                                                            \n";
                    foreach($prop->getCallback('Validate') as $val) {

                        $this->context['val'] = $val;
                        if (!$val->isLast()) {
                            echo "                    " . ($val->toCode($prop, $prop->getPHPVariable())) . "\n                    if (\$return === FALSE) {\n                        throw new \\RuntimeException(\"Validation failed for ";
                            echo $prop.'' . "\");\n                    }\n";
                        }
                    }
                    echo "\n";
                    if ($prop->getAnnotation()->has('Date')) {
                        echo "                    \$_date = \\date_create('" . "@" . "' . " . ($prop->getPHPVariable()) . "->sec);\n                    if (";
                        echo $validator->functionName($collection->getClass(), $prop->getPHPName()) . "(\$_date) === false) {\n                        throw new \\RuntimeException(\"Validation failed for ";
                        echo $prop.'' . "\");\n                    }\n";
                    }
                    else if (!$prop->isCustom() && $validator->hasRules($collection->getClass(), $prop->getPHPName())) {
                        echo "                    if (" . ($validator->functionName($collection->getClass(),  $prop->getPHPName())) . "(" . ($prop->getPHPVariable()) . ") === false) {\n                        throw new \\RuntimeException(\"Validation failed for ";
                        echo $prop.'' . "\");\n                    }\n";
                    }

                    echo "\n";
                    foreach($prop->getCallback('Validate') as $val) {

                        $this->context['val'] = $val;
                        if ($val->isLast()) {
                            echo "                    " . ($val->toCode($prop, $prop->getPHPVariable())) . "\n                    if (\$return === FALSE) {\n                        throw new \\RuntimeException(\"Validation failed for ";
                            echo $prop.'' . "\");\n                    }\n";
                        }
                    }
                    echo "            } else if (!empty(" . ($prop->getPHPVariable()) . ")) {\n                // always check\n";
                    foreach($prop->getCallback('Validate') as $val) {

                        $this->context['val'] = $val;
                        if ($val->isAlwaysCheck()) {
                            echo "                    " . ($val->toCode($prop, $prop->getPHPVariable())) . "\n                    if (\$return === FALSE) {\n                        throw new \\RuntimeException(\"Validation failed for ";
                            echo $prop.'' . "\");\n                    }\n";
                        }
                    }
                    echo "            }\n";
                }
                echo "\n        return \$doc;\n    }\n\n    protected function update_property_";
                echo sha1($collection->getClass()) . "(\\" . ($collection->getClass()) . " \$document, \$property, \$value)\n    {\n";
                if ($collection->getParent()) {
                    echo "            \$this->update_property_" . (sha1($collection->getParent())) . "(\$document, \$property, \$value);\n";
                }
                echo "        \$iproperty = strtolower(\$property);\n";
                foreach($collection->getProperties() as $prop) {

                    $this->context['prop'] = $prop;
                    echo "            if (\$property ==  ";
                    var_export($prop.'');
                    echo "\n";
                    foreach($prop->getAnnotation()->getAnnotations() as $annotation) {

                        $this->context['annotation'] = $annotation;
                        echo "                 || \$iproperty == ";
                        var_export('@'.$annotation->getName());
                        echo "\n";
                    }
                    echo "            ) {\n";
                    if ($prop->isPublic()) {
                        echo "                    \$document->" . ($prop->getPHPName()) . " = \$value;\n";
                    }
                    else {
                        echo "                    \$property = new \\ReflectionProperty(\$object, ";
                        var_export($prop->getPHPNAme());
                        echo ");\n                    \$property->setAccessible(true);\n                    \$property->setValue(\$document, \$value);\n";
                    }
                    echo "            }\n";
                }
                echo "    }\n\n\n";
                foreach($collections->getEvents() as $ev) {

                    $this->context['ev'] = $ev;
                    if ($collection->hasEvent($ev)) {
                        echo "    /**\n     *  Code for ";
                        echo $ev . " events for objects " . ($collection->getClass()) . "\n     */\n        protected function event_";
                        echo $ev . "_" . (sha1($collection->getClass())) . "(\$document, Array \$args)\n        {\n            \$class = \$this->get_class(\$document);\n";
                        if (!$collection->isTrait()) {
                            echo "            if (\$class != " . ($collection->getClassCode()) . " && !is_subclass_of(\$class, " . ($collection->getClassCode()) . ")) {\n                throw new \\Exception(\"Class invalid class name (\$class) expecting  \"  . ";
                            echo $collection->getClassCode() . ");\n            }\n";
                        }
                        echo "\n";
                        foreach($collection->getParentAndTraits() as $parent) {

                            $this->context['parent'] = $parent;
                            if ($parent->hasEvent($ev)) {
                                $method = "event_" . $ev . "_" . sha1($parent->getClass());
                                $this->context['method'] = $method;
                                echo "                \$this->" . ($method) . "(\$document, \$args);\n";
                            }
                        }
                        echo "\n";
                        foreach($collection->getMethodsByAnnotation($ev) as $method) {

                            $this->context['method'] = $method;
                            echo "                " . ($method->toCode($collection, '$document')) . "\n                if (\$return === FALSE) {\n                    throw new \\RuntimeException;\n                }\n";
                        }
                        echo "\n";
                        if ($ev =="postCreate" || $ev == "postUpdate") {
                            echo "                \$col = \$args[1]->getDatabase()->references_queue;\n";
                            ActiveMongo2\Template\Templates::exec("reference/deferred.tpl.php", compact('ev', 'collection'), $this->context);
                            if ($ev == "postUpdate") {
                                ActiveMongo2\Template\Templates::exec("reference/update.tpl.php", compact('ev', 'collection'), $this->context);
                            }
                        }
                        echo "\n";
                        foreach($collection->getPlugins($ev) as $plugin) {

                            $this->context['plugin'] = $plugin;
                            echo "                " . ($plugin->toCode($collection, '$document')) . "\n                if (\$return === FALSE) {\n                    throw new \\RuntimeException;\n                }\n";
                        }
                        echo "        }\n";
                    }
                }
                echo "\n";
            }
            echo "}\n\nclass ActiveMongo2Mapped\n{\n    protected \$class;\n    protected \$data;\n\n    public function __construct(\$name, Array \$data)\n    {\n        \$this->class = \$name;\n        \$this->data  = \$data;\n    }\n\n    public function getClass()\n    {\n        return \$this->class;\n    }\n\n    public function getOriginal()\n    {\n        return \$this->data;\n    }\n\n    public function ";
            echo $instance . "_setOriginal(Array \$data)\n    {\n        \$this->data = \$data;\n    }\n}\n\n";
            ActiveMongo2\Template\Templates::exec('validator', $this->context);
            echo "\nreturn array(\n    \"ns\" => ";
            var_export(trim($namespace, '\\'));
            echo ",\n    \"validator\" => ";
            var_export($valns);
            echo ",\n);\n";

            if ($return) {
                return ob_get_clean();
            }

        }
    }

    /** 
     *  Template class generated from Reference/Deferred.tpl.php
     */
    class class_7e3d172c6b9ee7fd7d68e93c41ee0d852447ceca extends base_template_df562f12800ad133cdbc6f040ca106a099504656
    {

        public function hasSection($name)
        {

            return false;
        }


        public function renderSection($name, Array $args = array(), $fail_on_missing = true)
        {
            if (!$this->hasSection($name)) {
                if ($fail_on_missing) {
                    throw new \RuntimeException("Cannot find section {$name}");
                }
                return "";
            }

        }

        public function enhanceException(Exception $e, $section = NULL)
        {
            if (!empty($e->enhanced)) {
                return;
            }

            $message = $e->getMessage() . "( IN " . 'Reference/Deferred.tpl.php';
            if ($section) {
                $message .= " | section: {$section}";
            }
            $message .= ")";

            $object   = new ReflectionObject($e);
            $property = $object->getProperty('message');
            $property->setAccessible(true);
            $property->setValue($e, $message);

            $e->enhanced = true;
        }

        public function render(Array $vars = array(), $return = false)
        {
            try {
                return $this->_render($vars, $return);
            } catch (Exception $e) {
                if ($return) ob_get_clean();
                $this->enhanceException($e);
                throw $e;
            }
        }

        public function _render(Array $vars = array(), $return = false)
        {
            $this->context = $vars;

            extract($vars);
            if ($return) {
                ob_start();
            }

            foreach($collection->getBackReferences() as $ref) {

                $this->context['ref'] = $ref;
                if ($ref['deferred']) {
                    if ($ev == "postCreate") {
                        echo "            \$check = !empty(\$args[0][";
                        var_export($ref['property']->getName());
                        echo "]);\n";
                    }
                    else {
                        echo "            \$check = !empty(\$args[0]['\$set'][";
                        var_export($ref['property']->getName());
                        echo "]);\n";
                    }
                    echo "        if (\$check) {\n";
                    if ($ref['multi']) {
                        echo "                \$data = array();\n";
                        if ($ev == "postCreate") {
                            echo "                    \$fields = \$args[0][";
                            var_export($ref['property']->getName());
                            echo "];\n";
                        }
                        else {
                            echo "                    \$fields = \$args[0]['\$set'][";
                            var_export($ref['property']->getName());
                            echo "];\n";
                        }
                        echo "                foreach (\$fields as \$id => \$row) {\n                    \$data[] = array(\n";
                        if ($ev == "postCreate") {
                            echo "                        'source_id' => ";
                            var_export($ref['target']->getName() . '::');
                            echo " . serialize(\$row['\$id']),\n                        'id'        => \$args[0]['_id'],\n";
                        }
                        else {
                            echo "                        'source_id' => ";
                            var_export($ref['target']->getName() . '::');
                            echo " . serialize(\$row['\$id']),\n                        'id'        => \$args[2],\n";
                        }
                        echo "                        'property'  => ";
                        var_export($ref['property']->getName() . '.');
                        echo " . \$id,\n                    );\n                }\n";
                    }
                    else {
                        echo "                \$data = array(array(\n";
                        if ($ev == "postCreate") {
                            echo "                    'source_id'     => ";
                            var_export($ref['target']->getName() . '::');
                            echo " . serialize(\$args[0][";
                            var_export($ref['property']->getName());
                            echo "]['\$id']),\n                    'id'            => \$args[0]['_id'],\n";
                        }
                        else {
                            echo "                    'source_id'     => ";
                            var_export($ref['target']->getName() . '::');
                            echo " . serialize(\$args[0]['\$set'][";
                            var_export($ref['property']->getName());
                            echo "]['\$id']),\n                    'id'            => \$args[2],\n";
                        }
                        echo "                    'property'      => ";
                        var_export($ref['property']->getName());
                        echo ",\n                ));\n";
                    }
                    echo "            foreach (\$data as \$row) {\n                \$row['collection'] = \$this->ns_by_name[";
                    var_export($ref['property']->getParent()->getName());
                    echo "] . ";
                    var_export($ref['property']->getParent()->getName());
                    echo ";\n                \$row['_id'] = array(\n                    'source' => \$row['source_id'], \n                    'target_id' => \$row['id'], \n                    'target_col' => \$row['collection'], \n                    'target_prop' => \$row['property']\n                );\n                \$col->save(\$row, array('w' => 1));\n            }\n        }\n";
                }
            }

            if ($return) {
                return ob_get_clean();
            }

        }
    }

    /** 
     *  Template class generated from Reference/Update.tpl.php
     */
    class class_f8c39509b1fb331e8b8ef22a135640af98725ce5 extends base_template_df562f12800ad133cdbc6f040ca106a099504656
    {

        public function hasSection($name)
        {

            return false;
        }


        public function renderSection($name, Array $args = array(), $fail_on_missing = true)
        {
            if (!$this->hasSection($name)) {
                if ($fail_on_missing) {
                    throw new \RuntimeException("Cannot find section {$name}");
                }
                return "";
            }

        }

        public function enhanceException(Exception $e, $section = NULL)
        {
            if (!empty($e->enhanced)) {
                return;
            }

            $message = $e->getMessage() . "( IN " . 'Reference/Update.tpl.php';
            if ($section) {
                $message .= " | section: {$section}";
            }
            $message .= ")";

            $object   = new ReflectionObject($e);
            $property = $object->getProperty('message');
            $property->setAccessible(true);
            $property->setValue($e, $message);

            $e->enhanced = true;
        }

        public function render(Array $vars = array(), $return = false)
        {
            try {
                return $this->_render($vars, $return);
            } catch (Exception $e) {
                if ($return) ob_get_clean();
                $this->enhanceException($e);
                throw $e;
            }
        }

        public function _render(Array $vars = array(), $return = false)
        {
            $this->context = $vars;

            extract($vars);
            if ($return) {
                ob_start();
            }

            $deferred_done = false;
            $this->context['deferred_done'] = $deferred_done;
            foreach($collection->getForwardReferences() as $ref) {

                $this->context['ref'] = $ref;
                echo "    // update " . ($collection->getName()) . " references in  " . ($ref['property']->getParent()->getName()) . " \n    // ";
                echo $ref['deferred'] ? 'ues' : 'no' . "\n";
                if ($ref['deferred']) {
                    if (!empty($deferred_done)) {
                        continue;
                    }
                }
                echo "    \n    \$replicate = array();\n";
                $deferred_done = true;
                $this->context['deferred_done'] = $deferred_done;
                echo "    foreach (\$args[0] as \$operation => \$values) {\n";
                foreach($ref['update'] as $field) {

                    $this->context['field'] = $field;
                    echo "            if (!empty(\$values[";
                    var_export($field);
                    echo "])) {\n";
                    if ($ref['deferred']) {
                        echo "                    \$replicate[\$operation][";
                        var_export($field);
                        echo "]  = \$values[";
                        var_export($field);
                        echo "];\n";
                    }
                    else if ($ref['multi']) {
                        echo "                    \$replicate[\$operation][";
                        var_export($ref['property']->getName().'.$.'.$field);
                        echo "] = \$values[";
                        var_export($field);
                        echo "];\n";
                    }
                    else {
                        echo "                    \$replicate[\$operation][";
                        var_export($ref['property']->getName().'.'.$field);
                        echo "] = \$values[";
                        var_export($field);
                        echo "];\n";
                    }

                    echo "            }\n";
                }
                echo "    }\n\n";
                if ($ref['deferred']) {
                    echo "        if (!empty(\$replicate)) {\n            // queue the updates!\n            \$data = array(\n                'update'    => \$replicate,\n                'processed' => false,\n                'created'   => new \\DateTime,\n                'source_id' => ";
                    var_export($collection->getName().'::');
                    echo "  . serialize(\$args[2]),\n                'type'      => array(\n                    'source'    => ";
                    var_export($collection->getName());
                    echo ",\n                    'target'    => ";
                    var_export($ref['property']->getParent()->getName());
                    echo ",\n                ),\n            );\n            \$args[1]\n                ->getDatabase()\n                ->deferred_queue\n                ->save(\$data, array('w' => 0));\n        }\n";
                    continue;
                }
                echo "\n    if (!empty(\$replicate)) {\n        // do the update\n        \$args[1]->getCollection(";
                var_export($ref['property']->getParent()->getName());
                echo ")\n            ->update([\n                '";
                echo $ref['property']->getName() . ".\$id' => \$args[2]], \n                \$replicate, \n                ['w' => 0, 'multi' => true]\n        );\n    }\n";
            }

            if ($return) {
                return ob_get_clean();
            }

        }
    }

    /** 
     *  Template class generated from Validator.tpl.php
     */
    class class_dcd0611a518789012418c0e75ffd0c19086462d0 extends base_template_df562f12800ad133cdbc6f040ca106a099504656
    {

        public function hasSection($name)
        {

            return false;
        }


        public function renderSection($name, Array $args = array(), $fail_on_missing = true)
        {
            if (!$this->hasSection($name)) {
                if ($fail_on_missing) {
                    throw new \RuntimeException("Cannot find section {$name}");
                }
                return "";
            }

        }

        public function enhanceException(Exception $e, $section = NULL)
        {
            if (!empty($e->enhanced)) {
                return;
            }

            $message = $e->getMessage() . "( IN " . 'Validator.tpl.php';
            if ($section) {
                $message .= " | section: {$section}";
            }
            $message .= ")";

            $object   = new ReflectionObject($e);
            $property = $object->getProperty('message');
            $property->setAccessible(true);
            $property->setValue($e, $message);

            $e->enhanced = true;
        }

        public function render(Array $vars = array(), $return = false)
        {
            try {
                return $this->_render($vars, $return);
            } catch (Exception $e) {
                if ($return) ob_get_clean();
                $this->enhanceException($e);
                throw $e;
            }
        }

        public function _render(Array $vars = array(), $return = false)
        {
            $this->context = $vars;

            extract($vars);
            if ($return) {
                ob_start();
            }

            $val = $validator->getVariables();
            $this->context['val'] = $val;
            $var = $val['var'];
            $this->context['var'] = $var;
            echo "\n";
            foreach($val['functions'] as $name => $body) {

                $this->context['name'] = $name;
                $this->context['body'] = $body;
                echo "function " . ($name) . " (" . ($var) . ")\n{\n    \$is_scalar = is_scalar(";
                echo $var . ");\n    ";
                echo $body->toCode($var) . "\n    return ";
                echo $body->result . ";\n}\n\n";
            }
            echo "\n";

            if ($return) {
                return ob_get_clean();
            }

        }
    }

}

namespace ActiveMongo2\Template {


    class Templates
    {
        public static function getAll()
        {
            return array (
                0 => 'callback',
                1 => 'documents',
                2 => 'reference/deferred',
                3 => 'reference/update',
                4 => 'validator',
            );
        }

        public static function getAllSections($name, $fail = true)
        {
            switch ($name) {
            default:
                if ($fail) {
                    throw new \RuntimeException("Cannot find section {$name}");
                }

                return array();
            }
        }

        public static function exec($name, Array $context = array(), Array $global = array())
        {
            $tpl = self::get($name);
            return $tpl->render(array_merge($global, $context));
        }

        public static function get($name, Array $context = array())
        {
            static $classes = array (
                'callback.tpl' => 'class_1895ec604b22a2e3f627b9d8d7ae6142d332247e',
                'callback' => 'class_1895ec604b22a2e3f627b9d8d7ae6142d332247e',
                'documents.tpl.php' => 'class_4c3d011cafbc519bc12f3ed430a4e169ad8b5e8b',
                'documents' => 'class_4c3d011cafbc519bc12f3ed430a4e169ad8b5e8b',
                'reference/deferred.tpl.php' => 'class_7e3d172c6b9ee7fd7d68e93c41ee0d852447ceca',
                'reference/deferred' => 'class_7e3d172c6b9ee7fd7d68e93c41ee0d852447ceca',
                'reference/update.tpl.php' => 'class_f8c39509b1fb331e8b8ef22a135640af98725ce5',
                'reference/update' => 'class_f8c39509b1fb331e8b8ef22a135640af98725ce5',
                'validator.tpl.php' => 'class_dcd0611a518789012418c0e75ffd0c19086462d0',
                'validator' => 'class_dcd0611a518789012418c0e75ffd0c19086462d0',
            );
            $name = strtolower($name);
            if (empty($classes[$name])) {
                throw new \RuntimeException("Cannot find template $name");
            }

            $class = "\\" . $classes[$name];
            return new $class;
        }
    }

}
